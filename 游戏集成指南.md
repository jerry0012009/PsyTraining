# 认知训练系统 - 游戏集成指南

本文档指导如何将HTML小游戏集成到认知训练系统中，确保数据质量和用户体验的一致性。

## 📖 系统架构

### 核心设计理念
- **完全解耦** - 训练系统与游戏系统独立运行
- **统一接口** - 所有游戏通过TrainingAPI与训练系统交互
- **数据驱动** - 基于游戏数据进行认知功能分析
- **用户友好** - 用户看到简洁的游戏界面，后台进行专业分析

### 系统组件结构
```
认知训练系统/
├── game-template/           # 🎮 通用训练系统（核心框架）
│   ├── template.html       # 训练界面模板
│   ├── template.css        # 训练界面样式  
│   └── template.js         # 训练逻辑控制器
├── games/                  # 🎯 游戏目录
│   ├── snake/             # Snake游戏（参考实现）
│   └── [新游戏]/           # 待集成的新游戏
├── [游戏名]-game.html      # 🖥️ 游戏页面
├── index.html              # 🏠 主页
└── README.md              # 📖 使用说明
```

## 🚀 集成流程（5步法）

### 步骤1：分析游戏特点
- **游戏类型**：反应类、策略类、记忆类、空间类
- **核心交互**：按键操作、鼠标操作、触摸操作
- **关键事件**：得分、失败、完成关卡、时间节点
- **认知需求**：注意力、记忆、执行功能、空间认知

### 步骤2：创建游戏目录
```bash
games/[游戏名]/
├── game.html          # 游戏界面组件
├── game.css           # 游戏样式文件
└── game.js            # 游戏逻辑系统（主要文件）
```

### 步骤3：实现游戏类（核心）
```javascript
class YourGame {
    constructor() {
        this.gameState = {
            isRunning: false, isPaused: false, currentRound: 0, score: 0
        };
        this.gameData = { rounds: [], currentRoundData: null };
        this.initializeGame();
    }

    // 🔴 必须实现 - 监听训练系统事件
    initializeGame() {
        window.addEventListener('trainingSystemEvent', (event) => {
            this.handleTrainingEvent(event.detail);
        });
    }

    // 🔴 必须实现 - 处理训练系统事件
    handleTrainingEvent(eventDetail) {
        switch (eventDetail.event) {
            case 'training_start': this.startFirstRound(); break;
            case 'training_pause': this.pauseGame(); break;
            case 'training_resume': this.resumeGame(); break;
            case 'training_end': this.endAllRounds(); break;
        }
    }

    // 🔴 必须实现 - 报告数据给训练系统
    reportToTrainingSystem() {
        const report = {
            gameType: 'your_game_name',
            currentRound: this.gameState.currentRound,
            roundData: this.gameData.currentRoundData,
            totalStats: { /* 基础统计 */ },
            cognitiveMetrics: this.calculateCognitiveMetrics()
        };
        
        if (window.TrainingAPI) {
            TrainingAPI.reportGameData(report);
        }
    }

    // 🔴 必须实现 - 计算认知功能指标
    calculateCognitiveMetrics() {
        // 详见认知功能分析框架
        return { /* 认知指标 */ };
    }
}
```

### 步骤4：创建游戏页面
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>[游戏名] - 心理测量训练</title>
    <link rel="stylesheet" href="game-template/template.css">
    <link rel="stylesheet" href="games/[游戏名]/game.css">
</head>
<body>
    <div class="game-platform">
        <!-- 复制标准的控制栏结构 -->
        <div class="control-bar">...</div>
        
        <!-- 游戏容器 -->
        <div class="game-container">
            <div id="game-content" class="game-content">
                <!-- 嵌入游戏HTML -->
                <!-- 添加游戏说明 -->
            </div>
        </div>
        
        <!-- 信息栏 -->
        <div class="info-bar">...</div>
    </div>

    <script src="game-template/template.js"></script>
    <script src="games/[游戏名]/game.js"></script>
</body>
</html>
```

### 步骤5：更新主页
在`index.html`中添加游戏卡片：
```html
<div class="game-card">
    <div class="game-icon"><i class="fas fa-[图标]"></i></div>
    <h3>[游戏名]</h3>
    <p>[游戏描述]</p>
    <a href="[游戏名]-game.html" class="game-btn">开始训练</a>
</div>
```

## 📋 代码规范要求

### 必须实现的方法
```javascript
// 🔴 必须实现
handleTrainingEvent(eventDetail)     // 处理训练系统事件
reportToTrainingSystem()             // 报告数据给训练系统
calculateCognitiveMetrics()          // 计算认知功能指标

// 🟡 建议实现
startFirstRound()                    // 开始第一轮
pauseGame() / resumeGame()           // 暂停/恢复游戏
endAllRounds()                       // 结束所有轮次
```

### 事件处理规范
```javascript
handleKeyDown(event) {
    // 🔴 重要：阻止页面滚动
    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(event.key)) {
        event.preventDefault();
    }
    
    // 🔴 重要：只记录关键事件，避免高频记录影响性能
    this.recordEvent('key_press', { key: event.key });
}

recordEvent(type, data = {}) {
    if (this.gameData.currentRoundData) {
        this.gameData.currentRoundData.events.push({
            timestamp: Date.now(), type, data
        });
    }
}
```

## 📊 数据格式标准

### 游戏报告数据结构
```javascript
const gameReport = {
    gameType: 'game_name',           // 游戏类型标识
    currentRound: 1,                 // 当前轮次
    
    roundData: {
        roundNumber: 1,              // 轮次编号
        startTime: 1640995200000,    // 开始时间戳
        endTime: 1640995260000,      // 结束时间戳
        duration: 60000,             // 持续时间(ms)
        score: 150,                  // 得分
        events: [{                   // 关键事件记录
            timestamp: 1640995210000,
            type: 'key_press',
            data: { key: 'ArrowUp' }
        }],
        gameSpecificData: {}         // 游戏特定数据
    },
    
    totalStats: {
        totalRounds: 5,              // 总轮数
        totalScore: 750,             // 总得分
        avgScore: 150,               // 平均得分
        maxScore: 200                // 最高得分
    },
    
    cognitiveMetrics: {}             // 认知功能分析
};
```

### JSON输出格式（控制台）
```javascript
// 系统会自动输出结构化JSON数据：
{
    "trainingInfo": {
        "startTime": "2024-01-01T12:00:00.000Z",
        "totalDurationSeconds": 300,
        "totalGameReports": 5
    },
    "gameDataSummary": {
        "totalRounds": 5,
        "averageScore": 17,
        "maxScore": 25,
        "scoreImprovement": 12
    },
    "cognitiveAnalysis": { /* 详细认知指标 */ },
    "detailedGameReports": [ /* 完整游戏数据 */ ]
}
```

## 🧠 认知功能分析框架

### 五大认知领域
1. **执行功能** - 计划能力、认知灵活性、冲动控制
2. **注意力功能** - 持续注意、选择注意、分散注意
3. **学习与记忆** - 工作记忆、学习能力、模式识别
4. **处理速度** - 反应时间、决策制定、信息处理
5. **空间认知** - 空间记忆、空间定向、视空间技能

### 游戏类型与认知领域对应
| 游戏类型 | 主要认知领域 | 关键指标 |
|---------|-------------|----------|
| **反应类游戏** | 处理速度、注意力 | 反应时间、准确性 |
| **策略类游戏** | 执行功能、学习记忆 | 规划能力、决策质量 |
| **记忆类游戏** | 学习记忆、注意力 | 记忆广度、保持率 |
| **空间类游戏** | 空间认知、执行功能 | 空间记忆、导航能力 |

### 认知指标计算示例
```javascript
calculateCognitiveMetrics() {
    const rounds = this.gameData.rounds;
    const scores = rounds.map(r => r.score);
    const durations = rounds.map(r => r.duration);
    
    // 计算辅助方法
    const mean = arr => arr.reduce((sum, val) => sum + val, 0) / arr.length;
    const std = arr => {
        const m = mean(arr);
        return Math.sqrt(arr.reduce((sum, val) => sum + (val - m) ** 2, 0) / arr.length);
    };
    
    return {
        // 注意力指标
        attention: {
            sustainedAttention: {
                attentionSpan: mean(durations) / 1000,
                consistencyIndex: 1 - (std(scores) / mean(scores))
            }
        },
        
        // 处理速度指标
        processingSpeed: {
            reactionTime: {
                avgReactionTime: this.calculateAvgReactionTime(),
                reactionConsistency: this.calculateReactionConsistency()
            }
        },
        
        // 元数据
        analysisMetadata: {
            totalRounds: rounds.length,
            dataQuality: this.assessDataQuality(rounds)
        }
    };
}
```

## 🧪 测试验证

### 功能测试清单
- [ ] 游戏正常启动和运行
- [ ] 训练系统事件响应正确
- [ ] 暂停/恢复功能正常
- [ ] 多轮游戏模式工作
- [ ] 数据记录完整准确
- [ ] JSON输出格式正确
- [ ] 认知指标计算合理
- [ ] 界面适配良好

### 性能要求
- 游戏运行流畅（>30fps）
- 数据记录不影响游戏性能
- 内存使用合理
- 长时间训练稳定

## ❓ 常见问题

**Q: 按键导致页面滚动？**
```javascript
// A: 阻止默认行为
if (['ArrowUp', 'ArrowDown'].includes(event.key)) {
    event.preventDefault();
}
```

**Q: 游戏运行卡顿？**
```javascript
// A: 优化数据记录，只记录关键事件
recordEvent(type, data = {}) {
    if (this.isKeyEvent(type) && Date.now() - this.lastRecordTime < 100) return;
    // 记录事件...
}
```

**Q: 认知指标异常？**
```javascript
// A: 添加数据验证
calculateCognitiveMetrics() {
    const metrics = this.computeMetrics();
    const validation = this.validateMetrics(metrics);
    if (!validation.isValid) {
        console.warn('指标异常:', validation.errors);
    }
    return metrics;
}
```

## 🎯 快速开始

1. **复制Snake游戏目录** `games/snake/` 作为模板
2. **替换游戏核心逻辑** 保持接口不变
3. **实现认知功能分析** 根据游戏特点设计
4. **创建游戏页面文件** 使用标准模板
5. **更新主页游戏列表** 添加新游戏卡片
6. **执行测试验证** 确保功能完整

---

**参考实现：** `games/snake/` - 完整的参考实现
**技术支持：** 如有问题，参考Snake游戏的实现细节

按照本指南，您可以快速、标准化地将任何HTML小游戏集成到认知训练系统中！🚀 