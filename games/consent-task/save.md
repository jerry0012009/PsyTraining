# 知情同意任务 - 数据保存机制

## 概述
知情同意任务是实验前的必要环节，用于确保参与者理解实验内容并自愿参与。该任务基于jsPsych 6.0.4框架构建，记录参与者的同意状态和相关行为数据。

## 数据保存机制

### 保存位置和方式
- **主要方式**: AJAX POST请求到服务器端点 `/save`
- **备用方式**: 当服务器不可用时，使用jsPsych本地保存功能
- **文件格式**: JSON格式
- **文件名**: `consent-task_results.json`

### 数据保存流程
1. 参与者阅读知情同意书内容
2. 勾选同意复选框并点击开始按钮
3. `check_consent()` 函数验证是否已勾选同意
4. 完成后触发 `on_finish` 回调进行数据保存
5. 序列化实验数据并发送到服务器或本地保存

### 保存的数据结构
```javascript
[
  {
    "trial_type": "external-html",          // 试验类型
    "trial_index": 0,                       // 试验序号
    "time_elapsed": 12456,                  // 总耗时(毫秒)
    "rt": 12456,                           // 反应时间(毫秒)
    "url": "study_info.html",              // 加载的HTML文件
    "exp_id": "consent-task",              // 实验标识符
    "internal_node_id": "0.0-0.0"         // jsPsych内部节点ID
  }
]
```

### 同意验证机制
- **验证函数**: `check_consent()` (第16-25行)
- **验证条件**: 检查ID为 `consent_checkbox` 的复选框是否被勾选
- **失败处理**: 显示中文警告"您必须勾选下方的复选框才能继续"
- **返回值**: true(同意)/false(未同意)

### 数据字段说明
- **trial_type**: 固定为 "external-html"，表示外部HTML加载试验
- **trial_index**: 通常为0，因为这是实验的第一个(唯一)试验
- **time_elapsed**: 从页面加载到完成同意的总时间
- **rt**: 反应时间，与time_elapsed相同
- **url**: 加载的知情同意书文件路径，默认为 "study_info.html"
- **exp_id**: 通过 `addID('consent-task')` 函数添加的实验标识符

### 代码实现位置
- **同意验证**: 第16-25行的 `check_consent()` 函数
- **试验配置**: 第32-38行的trial对象设置
- **数据保存**: 第47-69行的 `on_finish` 回调函数
- **ID添加**: 第44-46行的 `on_trial_finish` 回调

### URL参数处理
- **参数获取**: `$.QueryString.url` 获取URL参数
- **默认值**: 如果未指定URL参数，默认加载 "study_info.html"
- **灵活性**: 允许通过URL参数指定不同的同意书文件

### 错误处理机制
1. **服务器响应200**: 重定向到 `/next` 页面继续实验
2. **其他错误**: 调用 `jsPsych.data.get().localSave('json','consent-task_results.json')`
3. **本地保存**: 数据以JSON格式下载到用户设备

### 相关文件
- **study_info.html**: 默认的知情同意书内容文件
- **control.html**: 可能的控制组同意书
- **experimental.html**: 可能的实验组同意书
- **consent.css**: 同意书页面的样式文件

### 实验伦理合规
该任务确保：
- **知情**: 参与者了解实验目的、程序和风险
- **自愿**: 必须主动勾选同意复选框
- **记录**: 保存同意状态和时间戳作为伦理合规证据
- **可追溯**: 每个参与者的同意记录可独立验证

### 技术依赖
- **jsPsych 6.0.4**: 核心实验框架
- **external-html插件**: 加载外部HTML内容
- **jQuery**: DOM操作和AJAX请求
- **poldrack_utils.js**: 实验工具函数库

### 数据分析用途
保存的数据可用于：
- 验证参与者的合规参与状态
- 分析阅读同意书所需的时间
- 实验伦理文档和审查
- 参与者招募效果评估
- 法律和伦理合规证明

### 注意事项
- 必须确保同意书内容清晰、完整
- 复选框验证是强制性的，未勾选无法继续
- 数据保存失败时，本地保存确保不会丢失同意记录
- 建议定期备份同意记录以满足伦理审查要求